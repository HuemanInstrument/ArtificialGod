<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hueman Instrumentality</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:-apple-system,Arial,sans-serif;font-size:12px;line-height:1.6;overflow-x:hidden}
.header{background:#000;padding:15px 20px;position:fixed;top:0;left:0;right:0;z-index:1000;border-bottom:1px solid #fff}
.header-content{display:flex;align-items:center;gap:20px}
.site-title{font-size:14px;letter-spacing:1px;font-weight:400}
.social-links{display:flex;gap:15px}
.social-links a{color:#fff;text-decoration:none;font-size:11px;opacity:.7;transition:opacity .3s}
.social-links a:hover{opacity:1}
#distortionCanvas{position:fixed;top:50px;left:0;width:100%;height:calc(100%-50px);z-index:-1}
.container{max-width:480px;margin:0 auto;padding:80px 20px 100px;background:rgba(0,0,0,.85);min-height:100vh}
.post{margin-bottom:50px;padding-bottom:30px;border-bottom:1px solid rgba(255,255,255,0.1)}
.post-date{font-size:10px;opacity:.5;margin-bottom:10px;letter-spacing:1px}
.post-title{font-size:16px;margin-bottom:15px;font-weight:400;letter-spacing:.5px}
.post-content{font-size:11px;line-height:1.8;opacity:.9;white-space:pre-wrap;word-wrap:break-word}
.audio-player{position:fixed;bottom:0;left:0;right:0;background:#000;border-top:1px solid #fff;padding:10px;text-align:center}
html,body{height:100%} /* keep scrollbar */
body{overflow-y:scroll}
</style>
</head>
<body>
<div class="header">
    <div class="header-content">
        <h1 class="site-title">HUEMAN INSTRUMENTALITY</h1>
        <nav class="social-links">
            <a href="https://www.tiktok.com/@huemaninstrument">TIK</a>
            <a href="https://www.facebook.com/HuemanInstrument">FB</a>
            <a href="https://www.youtube.com/@HuemanInstrumentality">YT</a>
            <a href="https://www.instagram.com/huemaninstrument/">IG</a>
            <a href="https://www.tumblr.com/hueman-instrumentality">TMB</a>
            <a href="https://www.pinterest.com/HuemanInstrumentality/">PIN</a>
            <a href="https://truthsocial.com/@HuemanInstrumentality">TRU</a>
            <a href="https://x.com/EuclideanPlane">X</a>
            <a href="https://bsky.app/profile/huemaninstrument.bsky.social">BSK</a>
        </nav>
    </div>
</div>

<canvas id="distortionCanvas"></canvas>

<div class="container" id="content">
    <div class="loading">Loading posts...</div>
</div>

<div class="audio-player">
    <!-- Empty iframe – YouTube API will populate -->
    <iframe id="ytPlayer" width="0" height="0" allow="autoplay"></iframe>
</div>

<!-- YouTube iframe API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
// ==== Canvas distortion (bug‑fixed) ====
const canvas=document.getElementById('distortionCanvas');
const ctx=canvas.getContext('2d');
let vertices=[],lenses=[],gridSize=25,cols,rows,scrollOffset=0,time=0,lastLensTime=0;
function resizeCanvas(){
    const dpr=window.devicePixelRatio||1;
    canvas.style.width='100%';
    canvas.style.height=(window.innerHeight-50)+'px';
    canvas.width=Math.round(window.innerWidth*dpr);
    canvas.height=Math.round((window.innerHeight-50)*dpr);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr,dpr);
    cols=Math.ceil(canvas.width/dpr/gridSize)+4;
    rows=Math.ceil(canvas.height/dpr/gridSize)+4;
    vertices=[];
    for(let i=0;i<=cols;i++){
        vertices[i]=[];
        for(let j=0;j<=rows;j++){
            const x=(i-2)*gridSize;
            const y=(j-2)*gridSize;
            vertices[i][j]={x, y, originalX:x, originalY:y};
        }
    }
}
class Lens{
    constructor(){
        this.radius=(Math.random()*15+10)*25;
        this.x=Math.random()*canvas.width;
        this.y=-this.radius;
        this.speed=(Math.random()*0.3+0.3);
        this.drift=(Math.random()-0.5)*0.2;
    }
    update(){
        this.y+=this.speed;
        this.x+=this.drift;
        return this.y<canvas.height+this.radius;
    }
    distortVertex(v){
        const dx=v.x - this.x;
        const dy=v.y - this.y;
        const dist=Math.hypot(dx,dy);
        if(dist<this.radius){
            const factor=1-(dist/this.radius);
            const magnification=factor*factor*0.5;
            const push=dist*magnification;
            const angle=Math.atan2(dy,dx);
            v.x+=Math.cos(angle)*push;
            v.y+=Math.sin(angle)*push;
        }
    }
}
function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    scrollOffset+=0.3;
    if(scrollOffset>=gridSize*2){scrollOffset-=gridSize*2;}
    for(let i=0;i<=cols;i++){
        for(let j=0;j<=rows;j++){
            const v=vertices[i][j];
            v.x=v.originalX-scrollOffset;
            v.y=v.originalY-scrollOffset;
        }
    }
    for(const lens of lenses){
        for(let i=0;i<=cols;i++){
            for(let j=0;j<=rows;j++){
                lens.distortVertex(vertices[i][j]);
            }
        }
    }
    ctx.fillStyle='#000033';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    const offsetSquares=Math.floor(scrollOffset/gridSize);
    for(let i=0;i<cols;i++){
        for(let j=0;j<rows;j++){
            const p1=vertices[i][j],p2=vertices[i+1][j],p3=vertices[i+1][j+1],p4=vertices[i][j+1];
            const isDark=((i+j+offsetSquares*2)%2)===0;
            if(isDark){
                ctx.fillStyle='rgba(26,0,0,0.5)';
                ctx.beginPath();
                ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.lineTo(p3.x,p3.y);ctx.lineTo(p4.x,p4.y);
                ctx.closePath();ctx.fill();
            }
        }
    }
    lenses=lenses.filter(l=>l.update());
    if(time-lastLensTime>180 && lenses.length<3){
        if(Math.random()<0.3){lenses.push(new Lens());lastLensTime=time;}
    }
    time++;
    requestAnimationFrame(animate);
}
window.addEventListener('resize',resizeCanvas);
resizeCanvas();
for(let i=0;i<2;i++){setTimeout(()=>lenses.push(new Lens()),i*2000);}
animate();

// ==== Blog posts & YouTube logic ====
let player,currentVideoId=''; // default later
function onYouTubeIframeAPIReady(){
    // will be initialised after posts are loaded
    if(currentVideoId){
        player=new YT.Player('ytPlayer',{
            videoId:currentVideoId,
            playerVars:{autoplay:1,loop:1,playlist:currentVideoId,mute:1},
            events:{}
        });
    }
}

// Load posts
async function loadPosts(){
    const container=document.getElementById('content');
    container.innerHTML='';
    const posts=[];
    let num=1,fail=0;
    while(fail<5 && num<1000){
        const fname=`Data_${String(num).padStart(4,'0')}.txt`;
        try{
            const resp=await fetch(fname);
            if(resp.ok){
                const text=await resp.text();
                posts.push({num,text});
                fail=0;
            }else{fail++;}
        }catch(e){fail++;}
        num++;
    }
    posts.sort((a,b)=>b.num-a.num); // newest first
    if(posts.length===0){
        container.innerHTML='<div class="post"><div class="post-content">No posts found.</div></div>';
        return;
    }
    const observer=new IntersectionObserver(entries=>{
        entries.forEach(e=>{
            if(e.isIntersecting){
                const vid=e.target.dataset.youtube;
                if(vid && vid!==currentVideoId && player){
                    currentVideoId=vid;
                    player.loadVideoById({videoId:vid});
                }
            }
        });
    },{threshold:0.6});
    posts.forEach((p,idx)=>{
        const lines=p.text.split('\n');
        let dateHtml='',titleHtml='',youtubeId='';
        let cursor=0;
        if(lines[0] && lines[0].match(/\d{4}-\d{2}-\d{2}|JANUARY|FEBRUARY|MARCH|APRIL|MAY|JUNE|JULY|AUGUST|SEPTEMBER|OCTOBER|NOVEMBER|DECEMBER/i)){
            dateHtml=`<div class="post-date">${lines[0].toUpperCase()}</div>`;
            cursor=1;
        }
        if(lines[cursor] && lines[cursor].length>0 && lines[cursor].length<100){
            titleHtml=`<div class="post-title">${lines[cursor]}</div>`;
            cursor++;
        }
        // extract youtube line
        lines.forEach((l,i)=>{
            if(l.toUpperCase().startsWith('YOUTUBE:')){
                youtubeId=l.split(':')[1].trim();
                lines[i]=''; // strip from content
            }
        });
        const content=lines.slice(cursor).filter(Boolean).join('\n').trim();
        const postDiv=document.createElement('div');
        postDiv.className='post';
        postDiv.dataset.youtube=youtubeId;
        postDiv.innerHTML=`
            ${dateHtml}
            ${titleHtml}
            <div class="post-content">${content.replace(/\n/g,'<br>')}</div>
        `;
        container.appendChild(postDiv);
        observer.observe(postDiv);
        if(idx===0 && youtubeId){currentVideoId=youtubeId;} // newest post
    });
    // Initialise player if API already loaded
    if(typeof YT!=='undefined' && YT.Player && !player && currentVideoId){
        player=new YT.Player('ytPlayer',{
            videoId:currentVideoId,
            playerVars:{autoplay:1,loop:1,playlist:currentVideoId,mute:1},
            events:{}
        });
    }
}
loadPosts();
</script>
</body>
</html>
